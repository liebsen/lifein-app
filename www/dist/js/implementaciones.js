;var currentnode='/implementaciones',implementaciones=firebase.database().ref(currentnode),datosdeapoyo={},anim=LI.animation.transition;implementaciones.once('value').then(function(e){if(!e.val()){$('.spinner').fadeOut(anim.fadeOut,function(){$('.lista').delay(anim.delay).fadeIn()})}});firebase.database().ref('/datosdeapoyo').once('value').then(function(e){datosdeapoyo=e.val()});$(document).on('submit','#firebase-form',function(a){a.preventDefault();var e=$(this).serializeObject(),n=$(this).attr('key'),t=$(this).attr('admin-key'),o=$(this).attr('seguridad-key'),s=undefined,r=undefined,d=undefined,i={implementacion:{estado:(e.implementacion_estado?1:0),email:$.trim(e.implementacion_email).toLowerCase(),plan:e.implementacion_plan,direccion:$.trim(e.implementacion_direccion),geo:{lat:$('#implementacion_direccion').attr('lat'),lng:$('#implementacion_direccion').attr('lng')},sitioweb:$.trim(e.implementacion_web),telefono:$.trim(e.implementacion_telefono),titulo:$.trim(e.implementacion_titulo),modificado:moment().format('X')},administrador:{estado:(e.administrador_estado?1:0),email:$.trim(e.administrador_email).toLowerCase(),nombre:$.trim(e.administrador_nombre),empresa:$.trim(e.administrador_empresa),caduca:$.trim(e.administrador_caduca),telefono:$.trim(e.administrador_telefono),rol:'administrador'},seguridad:{estado:(e.seguridad_estado?1:0),email:$.trim(e.seguridad_email).toLowerCase(),nombre:$.trim(e.seguridad_nombre),empresa:$.trim(e.seguridad_empresa),caduca:$.trim(e.seguridad_caduca),telefono:$.trim(e.seguridad_telefono),rol:'seguridad'}};if(!n){n=implementaciones.push().key};i.administrador.scope=[n];i.seguridad.scope=[n];if(!t){t=firebase.database().ref('/administradores').push().key;r=t};if(!o){o=firebase.database().ref('/administradores').push().key;d=o};$('.spinner').fadeIn(anim.fadeIn,function(){return new Promise(function(e,a){return firebase.database().ref('/administradores/'+t).set(i.administrador).then(function(){if(r){var a=i.administrador;a.implementacion=i.implementacion.titulo;a.password=LI.randomString(12);return LI.createAccount('email_admin',a).then(function(){e()})}
else{e()}})}).then(function(){return firebase.database().ref('/administradores/'+o).update(i.seguridad).then(function(){if(d){var e=i.seguridad;e.implementacion=i.implementacion.titulo;e.password=LI.randomString(12);return LI.createAccount('email_seguridad',e).then(function(){return!0})}
else{return!0}})}).then(function(){return firebase.database().ref(currentnode+'/'+n).update(i.implementacion,function(e){if(e){swal('Error',e,'error')}
else{$('.spinner').fadeOut(anim.fadeOut*anim.factor,function(){$('#detail').fadeOut(anim.fadeOut,function(){$('.lista').fadeIn(anim.fadeIn,function(){LI.resetScroll();if(r||d){swal({title:'Implementaciones',text:'La implementación ha sido actualizada. '+(r?'<br>Se ha enviado una notificación de bienvenida con los datos de ingreso al administrador.':'')+(d?'<br>Se ha enviado una notificación de bienvenida con los datos de ingreso al seguridad.':''),type:'success',html:!0})}})})})}})})});return!1});$(document).on('click','.add-item',function(e){$('#detail').html($.templates('#form').render({key:null,data:{plan:''},datosdeapoyo:datosdeapoyo},LI)).promise().done(function(){$('.lista').fadeOut(anim.fadeOut,function(){$('#detail').delay(200).fadeIn(anim.fadeOut*anim.factor,function(){$('body,html').scrollTop(0);LI.initAutocomplete('implementacion_direccion');$('.datetimepicker').datetimepicker()})})})});$(document).on('click','.action.editar',function(){var e=$(this).data('key');$('body').attr('key',e);LI.setScroll();$('.spinner').fadeIn(anim.fadeIn*anim.factor,function(){firebase.database().ref(currentnode+'/'+e).once('value').then(function(a){var i=a.val();firebase.database().ref('/administradores/').once('value',function(n){var m=n.val(),c=Object.keys(m).length,t=[],o=[],r=undefined,d=undefined,s=0;n.forEach(function(n){s++;var m=n.val();if($.inArray(e,m.scope)>-1){if(m.rol=='administrador'){t.push(m);r=n.key}
else if(m.rol=='seguridad'){o.push(m);d=n.key}};if(s===c){$('#detail').html($.templates('#form').render({key:a.key,data:i,adminKey:r,admin:t[0],seguridad:o[0],seguridadKey:d,datosdeapoyo:datosdeapoyo},LI)).promise().done(function(){$('.lista').fadeOut(anim.fadeOut,function(){$('.spinner').fadeOut(anim.fadeOut*anim.factor,function(){$('#detail').delay(200).fadeIn(anim.fadeOut*anim.factor,function(){$('body,html').scrollTop(0);LI.initAutocomplete('implementacion_direccion');$('.datetimepicker').datetimepicker();if(i.geo){$('#implementacion_direccion').attr('lat',i.geo.lat).attr('lng',i.geo.lng)}})})})})}})})})})});$(document).on('click','.action.eliminar',function(){var e=$(this).data('key');swal({title:'Atención',text:'Se eliminará esta implementación y sus administradores de forma permanente. ¿Desea continuar?',type:'warning',showCancelButton:!0,closeOnConfirm:!1,showLoaderOnConfirm:!0,},function(){var a=firebase.database().ref('/administradores/');a.once('value',function(a){var n=Object.keys(a.val()).length,t=[],i=0;a.forEach(function(a){i++;var t=a.val();if($.inArray(e,t.scope)>-1){firebase.database().ref('/administradores/'+t.key).remove()};if(i===n){firebase.database().ref('implementaciones/'+e).remove().then(function(){swal.close()})}})})})});$(document).on('click','.cerrar',function(){$('#detail').fadeOut(anim.fadeOut,function(){$('.lista').delay(anim.delay).fadeIn(anim.fadeIn,function(){LI.resetScroll()})})});implementaciones.on('child_added',(data)=>{firebase.database().ref('/administradores/').once('value',function(e){var t=Object.keys(e.val()).length,a=[],i=[],n=0;e.forEach(function(e){n++;var o=e.val();if(typeof o.scope=='object'&&$.inArray(data.key,o.scope)>-1){if(o.rol=='administrador'){a.push(o)}
else if(o.rol=='seguridad'){i.push(o)}};if(n===t){$('#list').prepend($.templates('#item').render({key:data.key,data:data.val(),admins:a,seguridad:i},LI)).promise().done(function(){$('#list').find('#'+data.key).animateAdded()});$('.spinner').fadeOut(anim.fadeOut*anim.factor,function(){$('.lista').delay(anim.delay).fadeIn()})}})})});implementaciones.on('child_changed',(data)=>{firebase.database().ref('/administradores/').once('value',function(e){var t=Object.keys(e.val()).length,a=[],i=[],n=0;e.forEach(function(e){n++;var o=e.val();if(typeof o.scope=='object'&&$.inArray(data.key,o.scope)>-1){if(o.rol=='administrador'){a.push(o)}
else if(o.rol=='seguridad'){i.push(o)}};if(n===t){var r=$('#'+data.key).index();$('#'+data.key).remove();console.log(r);$('#list').insertAt(r,$.templates('#item').render({key:data.key,data:data.val(),admins:a,seguridad:i},LI));$('#'+data.key).animateChanged()}})})});implementaciones.on('child_removed',(data)=>{$('#'+data.key).animateRemoved(function(){$(this).remove()})});$.datetimepicker.setLocale('es')